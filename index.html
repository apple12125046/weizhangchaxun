<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>违章代码速查</title>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 配置Tailwind自定义主题 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1677ff',
            secondary: '#f5f5f5',
            neutral: '#666666',
            light: '#fafafa',
            dark: '#333333'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-shadow {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .input-focus {
        @apply focus:border-primary focus:ring-1 focus:ring-primary focus:outline-none;
      }
    }
  </style>
</head>
<body class="bg-secondary min-h-screen font-sans">
  <div class="container mx-auto px-4 py-8 max-w-3xl">
    <!-- 页面标题 -->
    <header class="text-center mb-8">
      <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-primary mb-2">违章代码速查</h1>
      <p class="text-neutral text-sm">输入违章代码，快速查询详细违章信息</p>
    </header>
    
    <!-- 主内容区 -->
    <main>
      <!-- 搜索框 -->
      <div class="bg-white rounded-xl p-6 card-shadow mb-8">
        <div class="flex items-center space-x-4">
          <i class="fa fa-search text-primary text-xl"></i>
          <input 
            type="text" 
            id="violationCode" 
            placeholder="请输入违章代码" 
            class="flex-1 py-3 px-4 border border-gray-200 rounded-lg input-focus text-lg"
          >
        </div>
      </div>
      
      <!-- 结果显示区 -->
      <div id="resultContainer" class="bg-white rounded-xl p-6 card-shadow mb-8 hidden">
        <div class="grid grid-cols-1 gap-4">
          <div class="flex">
            <div class="w-1/3 text-dark font-medium">具体违章现象:</div>
            <div class="w-2/3 text-neutral" id="phenomenon"></div>
          </div>
          <div class="flex">
            <div class="w-1/3 text-dark font-medium">违章类型:</div>
            <div class="w-2/3 text-neutral" id="violationType"></div>
          </div>
          <div class="flex">
            <div class="w-1/3 text-dark font-medium">扣分对象:</div>
            <div class="w-2/3 text-neutral" id="punishmentTarget"></div>
          </div>
          <div class="flex">
            <div class="w-1/3 text-dark font-medium">安全生产禁令:</div>
            <div class="w-2/3 text-neutral" id="safetyRegulation"></div>
          </div>
        </div>
      </div>
      
      <!-- 数据上传区 -->
      <div class="bg-white rounded-xl p-6 card-shadow">
        <h2 class="text-xl font-semibold text-dark mb-4">基础数据管理</h2>
        
        <div class="flex flex-col md:flex-row gap-4 mb-4">
          <div class="flex-1">
            <label for="excelFile" class="block text-sm font-medium text-neutral mb-2">上传违章代码Excel文件</label>
            <div class="flex items-center">
              <input 
                type="file" 
                id="excelFile" 
                accept=".xlsx,.xls" 
                class="hidden"
              >
              <button 
                id="uploadBtn" 
                class="bg-primary hover:bg-primary/90 text-white py-2 px-6 rounded-lg transition-all duration-300 flex items-center"
              >
                <i class="fa fa-upload mr-2"></i> 选择文件
              </button>
              <span id="fileName" class="ml-4 text-neutral truncate max-w-[200px]"></span>
            </div>
          </div>
        </div>
        
        <div id="uploadStatus" class="py-3 px-4 rounded-lg mb-3 hidden"></div>
        
        <div class="flex justify-between items-center">
          <div class="text-sm text-neutral">
            <i class="fa fa-info-circle text-primary mr-1"></i> 
            Excel需包含：违章代码、具体违章现象、违章类型、扣分对象、安全生产禁令
          </div>
          <button 
            id="saveBtn" 
            class="bg-primary hover:bg-primary/90 text-white py-2 px-6 rounded-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed hidden"
          >
            <i class="fa fa-save mr-2"></i> 保存数据
          </button>
        </div>
      </div>
    </main>
    
    <!-- 页脚 -->
    <footer class="mt-12 text-center text-neutral text-sm py-4">
      <p>© 2025 违章代码速查 | 钉钉H5应用</p>
    </footer>
  </div>
  
  <!-- 引入SheetJS库用于解析Excel文件 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <!-- 引入钉钉JSAPI -->
  <script src="https://g.alicdn.com/dingding/open-develop/1.6.0/dingtalk.js"></script>
  
  <!-- 应用逻辑 -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 数据存储
      let violationData = [];
      let selectedFile = null;
      
      // DOM元素
      const codeInput = document.getElementById('violationCode');
      const resultContainer = document.getElementById('resultContainer');
      const phenomenonEl = document.getElementById('phenomenon');
      const typeEl = document.getElementById('violationType');
      const punishmentEl = document.getElementById('punishmentTarget');
      const regulationEl = document.getElementById('safetyRegulation');
      const excelFile = document.getElementById('excelFile');
      const uploadBtn = document.getElementById('uploadBtn');
      const fileNameEl = document.getElementById('fileName');
      const saveBtn = document.getElementById('saveBtn');
      const uploadStatus = document.getElementById('uploadStatus');
      
      // 初始化
      init();
      
      // 初始化函数
      function init() {
        // 检查本地存储中是否有违章数据
        const savedData = localStorage.getItem('violationData');
        if (savedData) {
          violationData = JSON.parse(savedData);
          showStatus('已加载本地违章数据，共' + violationData.length + '条记录', 'success');
        }
        
        // 绑定事件
        codeInput.addEventListener('input', handleCodeInput);
        uploadBtn.addEventListener('click', () => excelFile.click());
        excelFile.addEventListener('change', handleFileSelect);
        saveBtn.addEventListener('click', saveData);
        
        // 初始化钉钉环境
        initDingTalkEnv();
      }
      
      // 初始化钉钉环境
      function initDingTalkEnv() {
        // 判断是否在钉钉客户端内
        if (dd.env.platform !== 'notInDingTalk') {
          // 在钉钉内，初始化JSAPI
          dd.ready(function() {
            showStatus('已成功接入钉钉环境', 'success');
          });
          
          dd.error(function(err) {
            showStatus('钉钉环境初始化失败: ' + JSON.stringify(err), 'error');
          });
        } else {
          showStatus('当前不在钉钉客户端内，某些功能可能受限', 'warning');
        }
      }
      
      // 处理违章代码输入
      function handleCodeInput(e) {
        const code = e.target.value.trim();
        
        if (code) {
          // 查找违章信息
          const result = violationData.find(item => item.code === code);
          
          if (result) {
            // 显示查询结果
            phenomenonEl.textContent = result.phenomenon;
            typeEl.textContent = result.type;
            punishmentEl.textContent = result.punishmentTarget;
            regulationEl.textContent = result.safetyRegulation;
            resultContainer.classList.remove('hidden');
            resultContainer.classList.add('animate-fade-in');
          } else {
            // 未找到结果
            resultContainer.classList.add('hidden');
            showStatus('未找到对应的违章代码', 'warning');
          }
        } else {
          // 输入为空，隐藏结果
          resultContainer.classList.add('hidden');
        }
      }
      
      // 处理文件选择
      function handleFileSelect(e) {
        const file = e.target.files[0];
        
        if (file) {
          selectedFile = file;
          fileNameEl.textContent = file.name;
          fileNameEl.classList.remove('hidden');
          saveBtn.classList.remove('hidden');
          showStatus('已选择文件: ' + file.name, 'info');
        }
      }
      
      // 解析Excel文件
      function parseExcel(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              
              // 获取第一个工作表
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              
              // 转换为JSON
              const jsonData = XLSX.utils.sheet_to_json(worksheet);
              
              // 验证数据格式
              if (jsonData.length === 0) {
                reject('Excel文件中没有数据');
                return;
              }
              
              // 检查必要的列
              const firstRow = jsonData[0];
              const requiredFields = ['违章代码', '具体违章现象', '违章类型', '扣分对象', '安全生产禁令'];
              
              for (const field of requiredFields) {
                if (!Object.keys(firstRow).includes(field)) {
                  reject(`Excel文件缺少必要的列: ${field}`);
                  return;
                }
              }
              
              // 格式化数据
              const formattedData = jsonData.map(item => ({
                code: String(item['违章代码']),
                phenomenon: String(item['具体违章现象']),
                type: String(item['违章类型']),
                punishmentTarget: String(item['扣分对象']),
                safetyRegulation: String(item['安全生产禁令'])
              }));
              
              resolve(formattedData);
            } catch (error) {
              reject('Excel解析错误: ' + error.message);
            }
          };
          
          reader.onerror = function() {
            reject('文件读取错误');
          };
          
          reader.readAsArrayBuffer(file);
        });
      }
      
      // 保存数据
      async function saveData() {
        if (!selectedFile) {
          showStatus('请先选择Excel文件', 'warning');
          return;
        }
        
        showStatus('正在解析Excel文件...', 'info');
        
        try {
          // 解析Excel文件
          const data = await parseExcel(selectedFile);
          
          // 保存到本地
          violationData = data;
          localStorage.setItem('violationData', JSON.stringify(data));
          
          // 显示成功消息
          showStatus('数据保存成功，共' + data.length + '条记录', 'success');
          
          // 隐藏保存按钮
          saveBtn.classList.add('hidden');
          
          // 如果当前有输入的代码，重新查询
          if (codeInput.value.trim()) {
            handleCodeInput({ target: codeInput });
          }
        } catch (error) {
          showStatus(error, 'error');
        }
      }
      
      // 显示状态消息
      function showStatus(message, type = 'info') {
        uploadStatus.textContent = message;
        uploadStatus.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'bg-yellow-100', 'text-yellow-800');
        
        switch (type) {
          case 'success':
            uploadStatus.classList.add('bg-green-100', 'text-green-800');
            break;
          case 'error':
            uploadStatus.classList.add('bg-red-100', 'text-red-800');
            break;
          case 'warning':
            uploadStatus.classList.add('bg-yellow-100', 'text-yellow-800');
            break;
          case 'info':
          default:
            uploadStatus.classList.add('bg-blue-100', 'text-blue-800');
            break;
        }
        
        // 3秒后自动隐藏
        clearTimeout(window.statusTimeout);
        window.statusTimeout = setTimeout(() => {
          uploadStatus.classList.add('hidden');
        }, 5000);
      }
    });
  </script>
</body>
</html>